<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Morphology Mech: Word Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&display=swap');
        
        body {
            font-family: 'Share Tech Mono', monospace;
            background-color: #0f172a; /* slate-900 */
            color: #38bdf8; /* sky-400 */
            overflow-x: hidden;
        }

        .mech-panel {
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 2px solid #0369a1;
            box-shadow: 0 0 15px rgba(3, 105, 161, 0.5), inset 0 0 20px rgba(0, 0, 0, 0.8);
        }

        .mech-screen {
            background-color: #022c22;
            border: 4px solid #064e3b;
            box-shadow: inset 0 0 10px #000;
            color: #34d399;
            text-shadow: 0 0 5px #34d399;
        }

        .part-btn {
            transition: all 0.2s ease;
            border: 1px solid #334155;
            background-color: #1e293b;
        }

        .part-btn:hover {
            background-color: #334155;
            border-color: #38bdf8;
        }

        .part-btn.active {
            background-color: #0369a1;
            color: #fff;
            border-color: #7dd3fc;
            box-shadow: 0 0 10px #0ea5e9;
        }

        .scan-line {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background-color: rgba(52, 211, 153, 0.5);
            opacity: 0;
            box-shadow: 0 0 10px rgba(52, 211, 153, 1);
        }

        @keyframes scan {
            0% { top: 0; opacity: 1; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .scanning .scan-line {
            animation: scan 1.5s ease-in-out;
        }

        /* Writing Lab Editor Styles */
        .editor-container {
            position: relative;
            font-family: 'Share Tech Mono', monospace;
            font-size: 1.125rem;
            line-height: 1.5;
        }
        .editor-backdrop {
            position: absolute;
            z-index: 1;
            inset: 0;
            padding: 1rem;
            color: #94a3b8; /* slate-400 for normal text */
            white-space: pre-wrap;
            word-wrap: break-word;
            overflow-y: auto;
            pointer-events: none;
        }
        .editor-textarea {
            position: absolute;
            z-index: 2;
            inset: 0;
            padding: 1rem;
            width: 100%; 
            height: 100%;
            background: transparent;
            color: transparent; /* Make typed text invisible so backdrop shows through */
            caret-color: #38bdf8; /* blue cursor */
            resize: none;
            outline: none;
            overflow-y: auto;
        }

        /* Custom Scrollbar for lists */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #0f172a; 
        }
        ::-webkit-scrollbar-thumb {
            background: #0369a1; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #0ea5e9; 
        }
    </style>
</head>
<body class="h-screen flex flex-col p-2 sm:p-4 overflow-hidden">

    <!-- Header -->
    <header class="text-center mb-2 sm:mb-4 shrink-0">
        <h1 class="text-3xl sm:text-4xl font-bold text-sky-400 drop-shadow-[0_0_10px_rgba(56,189,248,0.8)] tracking-wider">MORPHOLOGY MECH</h1>
        <p class="text-sm sm:text-base text-sky-200 mt-1">Construct words. Decode meanings. Power up the core.</p>
    </header>

    <!-- Main Interface -->
    <main class="flex-grow flex flex-col lg:flex-row gap-3 sm:gap-4 max-w-7xl mx-auto w-full min-h-0">
        
        <!-- Left: Word Assembly Station -->
        <section class="lg:w-2/3 flex flex-col gap-3 min-h-0">
            
            <!-- Mech Screen (Output) -->
            <div id="mech-display" class="mech-screen rounded-xl p-4 sm:p-6 relative overflow-hidden flex flex-col items-center justify-center min-h-[160px] shrink-0">
                <div class="scan-line"></div>
                <div class="text-xs uppercase tracking-widest text-emerald-700 absolute top-2 left-2">System Output</div>
                <div class="text-xs uppercase tracking-widest text-emerald-700 absolute top-2 right-2">Status: <span id="status-indicator" class="text-emerald-500">Ready</span></div>
                
                <h2 id="assembled-word" class="text-4xl sm:text-5xl font-bold tracking-widest mt-2 sm:mt-4">_ _ _</h2>
                <div id="literal-meaning" class="text-base sm:text-lg text-emerald-300 mt-2 text-center max-w-lg h-6">Select parts to begin assembly.</div>
                
                <div id="word-verdict" class="mt-2 px-4 py-1 rounded text-xs sm:text-sm font-bold opacity-0 transition-opacity duration-300 border-2">
                    <!-- Verdict appears here -->
                </div>
            </div>

            <button id="analyze-btn" class="mech-panel w-full py-2 sm:py-3 text-lg sm:text-xl font-bold text-sky-300 hover:text-white hover:bg-sky-900 rounded-xl transition-all shadow-[0_0_15px_rgba(3,105,161,0.5)] active:scale-95 shrink-0">
                [ ENGAGE ANALYSIS SCANNER ]
            </button>

            <!-- Assembly Controls (Columns) -->
            <div class="grid grid-cols-3 gap-2 sm:gap-4 mech-panel p-2 sm:p-4 rounded-xl flex-grow min-h-0">
                
                <!-- Prefixes -->
                <div class="flex flex-col h-full min-h-0">
                    <div class="text-center mb-2 border-b border-sky-800 pb-1 shrink-0">
                        <h3 class="text-base sm:text-lg font-bold text-sky-300">PREFIX</h3>
                        <p class="text-[10px] sm:text-xs text-slate-400">(Beginning)</p>
                    </div>
                    <div id="prefix-list" class="flex flex-col gap-2 overflow-y-auto pr-1 sm:pr-2 flex-grow">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Roots -->
                <div class="flex flex-col h-full min-h-0">
                    <div class="text-center mb-2 border-b border-sky-800 pb-1 shrink-0">
                        <h3 class="text-base sm:text-lg font-bold text-sky-300">ROOT</h3>
                        <p class="text-[10px] sm:text-xs text-slate-400">(Core Meaning)</p>
                    </div>
                    <div id="root-list" class="flex flex-col gap-2 overflow-y-auto pr-1 sm:pr-2 flex-grow">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Suffixes -->
                <div class="flex flex-col h-full min-h-0">
                    <div class="text-center mb-2 border-b border-sky-800 pb-1 shrink-0">
                        <h3 class="text-base sm:text-lg font-bold text-sky-300">SUFFIX</h3>
                        <p class="text-[10px] sm:text-xs text-slate-400">(Ending)</p>
                    </div>
                    <div id="suffix-list" class="flex flex-col gap-2 overflow-y-auto pr-1 sm:pr-2 flex-grow">
                        <!-- Populated by JS -->
                    </div>
                </div>

            </div>
            
        </section>

        <!-- Right: Lab Notes / Inventory -->
        <section class="lg:w-1/3 mech-panel rounded-xl p-3 sm:p-4 flex flex-col min-h-0">
            <div class="flex justify-between items-center border-b border-sky-800 pb-2 mb-2 sm:mb-4 shrink-0">
                <h3 class="text-xl sm:text-2xl font-bold text-center flex-grow">Discovery Log</h3>
                <button id="open-writing-btn" class="hidden bg-sky-900 hover:bg-sky-700 text-sky-200 p-2 rounded-lg border border-sky-500 transition-all shadow-[0_0_10px_rgba(56,189,248,0.4)]" title="Open Writing Lab">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" />
                    </svg>
                    <span class="text-xs block text-center mt-1 uppercase">Write</span>
                </button>
            </div>
            
            <div class="flex justify-between text-xs sm:text-sm mb-2 px-2 shrink-0">
                <span>Real Words: <span id="real-count" class="text-green-400">0</span></span>
                <span>Mutants: <span id="mutant-count" class="text-purple-400">0</span></span>
            </div>

            <div class="bg-slate-900 flex-grow rounded border border-slate-700 p-2 overflow-y-auto min-h-0">
                <ul id="discovery-list" class="space-y-2 text-xs sm:text-sm">
                    <li class="text-slate-500 italic text-center mt-4">Log empty. Start combining parts!</li>
                </ul>
            </div>
            
            <button id="clear-log-btn" class="mt-2 sm:mt-4 border border-red-900 text-red-500 hover:bg-red-950 py-1 sm:py-2 rounded text-xs sm:text-sm transition-colors shrink-0">
                Clear Log
            </button>
        </section>

    </main>

    <!-- Writing Lab Modal (Hidden by default) -->
    <div id="writing-lab-modal" class="hidden fixed inset-0 z-50 bg-slate-900/95 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="mech-panel w-full max-w-5xl h-[90vh] rounded-2xl flex flex-col p-4 sm:p-6 border-4 border-sky-700 relative shadow-[0_0_50px_rgba(3,105,161,0.6)]">
            
            <button id="close-writing-btn" class="absolute top-4 right-4 text-sky-400 hover:text-white bg-slate-800 hover:bg-red-900 p-2 rounded border border-sky-800 hover:border-red-500 transition-colors">
                âœ• CLOSE
            </button>

            <h2 class="text-3xl font-bold text-sky-400 tracking-widest text-center mb-2">SYNTHESIS LAB</h2>
            <p class="text-center text-slate-400 text-sm mb-4">Construct a narrative using your discovered words. Real words appear <span class="text-green-400">green</span>, mutant words appear <span class="text-purple-400">purple</span>.</p>

            <div class="flex flex-col lg:flex-row gap-4 flex-grow min-h-0">
                
                <!-- Word Bank -->
                <div class="lg:w-1/4 bg-slate-800 rounded-xl border-2 border-slate-700 p-3 flex flex-col min-h-[150px]">
                    <h3 class="text-sky-300 font-bold border-b border-slate-600 pb-1 mb-2">Word Bank</h3>
                    <div id="word-bank-list" class="flex flex-wrap gap-2 overflow-y-auto content-start flex-grow">
                        <!-- Populated via JS -->
                    </div>
                </div>

                <!-- Editor -->
                <div class="lg:w-3/4 flex flex-col bg-slate-950 rounded-xl border-2 border-sky-900 overflow-hidden relative">
                    <div class="bg-sky-950/50 p-2 flex justify-between items-center border-b border-sky-900 shrink-0">
                        <span class="text-sm text-sky-200">System.Text.Input</span>
                        <span id="story-progress" class="text-sm font-bold text-emerald-400">0 / 10 Words Used</span>
                    </div>
                    
                    <div class="editor-container flex-grow h-full bg-[#050b14]">
                        <div id="highlight-layer" class="editor-backdrop"></div>
                        <textarea id="story-textarea" class="editor-textarea" spellcheck="false" placeholder="Begin transmission..."></textarea>
                    </div>
                </div>
            </div>

            <!-- Send Button -->
            <div class="mt-4 flex justify-end shrink-0">
                <button id="send-story-btn" class="hidden bg-emerald-700 hover:bg-emerald-600 text-white px-8 py-3 rounded-xl font-bold tracking-wider border-2 border-emerald-400 shadow-[0_0_15px_rgba(52,211,153,0.5)] transition-all flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                    </svg>
                    TRANSMIT TO HEADQUARTERS
                </button>
            </div>

        </div>
    </div>

    <!-- Data and Logic -->
    <script>
        // --- 1. Mophology Data ---
        // Appropriate for 4th/5th grade level
        const prefixes = [
            { id: 'p_none', text: '---', meaning: '', type: 'none' },
            { id: 'p1', text: 'un', meaning: 'not', type: 'prefix' },
            { id: 'p2', text: 're', meaning: 'again or back', type: 'prefix' },
            { id: 'p3', text: 'pre', meaning: 'before', type: 'prefix' },
            { id: 'p4', text: 'tele', meaning: 'far or distant', type: 'prefix' },
            { id: 'p5', text: 'micro', meaning: 'very small', type: 'prefix' },
            { id: 'p6', text: 'sub', meaning: 'under or below', type: 'prefix' },
            { id: 'p7', text: 'inter', meaning: 'between or among', type: 'prefix' }, // swapped bio for inter
            { id: 'p8', text: 'trans', meaning: 'across or beyond', type: 'prefix' },
            { id: 'p9', text: 'anti', meaning: 'against', type: 'prefix' },
            { id: 'p10', text: 'de', meaning: 'down or remove', type: 'prefix' }
        ];

        const roots = [
            { id: 'r1', text: 'graph', meaning: 'to write or draw' },
            { id: 'r2', text: 'port', meaning: 'to carry' },
            { id: 'r3', text: 'dict', meaning: 'to say or speak' },
            { id: 'r4', text: 'meter', meaning: 'to measure' },
            { id: 'r5', text: 'struct', meaning: 'to build' },
            { id: 'r6', text: 'phon', meaning: 'sound' },
            { id: 'r7', text: 'scop', meaning: 'to look or see' },
            { id: 'r8', text: 'chron', meaning: 'time' },
            { id: 'r9', text: 'tract', meaning: 'to pull or drag' },
            { id: 'r10', text: 'ject', meaning: 'to throw' },
            { id: 'r11', text: 'bio', meaning: 'life' } // added bio here
        ];

        const suffixes = [
            { id: 's_none', text: '---', meaning: '', type: 'none' },
            { id: 's1', text: 'er', meaning: 'a person or thing that does' },
            { id: 's2', text: 'or', meaning: 'a person or thing that does' },
            { id: 's3', text: 'able', meaning: 'capable of being' },
            { id: 's4', text: 'ible', meaning: 'capable of being' },
            { id: 's5', text: 'ology', meaning: 'the study of' },
            { id: 's6', text: 'tion', meaning: 'the action or process of' },
            { id: 's7', text: 'ic', meaning: 'having characteristics of' },
            { id: 's8', text: 'less', meaning: 'without' },
            { id: 's9', text: 'ful', meaning: 'full of' },
            { id: 's10', text: 'e', meaning: '(makes word a noun/verb)', type: 'silent' } // Helpful for words like scope, dictate
        ];

        // Dictionary of actual valid English combinations (expanded)
        const dictionary = new Set([
            'telegraph', 'telephone', 'telescope', 'microscope', 'microbiology',
            'biology', 'chronology', 'transport', 'transportable', 'transportation',
            'report', 'reporter', 'reportable', 'predict', 'predictable', 'unpredictable',
            'prediction', 'predictor', 'construct', 'construction', 'reconstruct', 
            'deconstruct', 'destruct', 'destruction', 'destructible', 'structure', 
            'restructure', 'substructure', 'destructure', 'subtract', 'subtractor', 
            'subtraction', 'tractor', 'attract', 'attraction', 'reject', 'rejection',
            'inject', 'injection', 'project', 'projector', 'projection', 'phonograph', 
            'meter', 'barometer', 'thermometer', 'dictate', 'dictator', 'dictation', 
            'diction', 'portable', 'export', 'import', 'struct', 'retract', 'retractable', 
            'retractor', 'retraction', 'detract', 'detractor', 'detraction', 'tractable', 
            'traction', 'scope', 'telescopic', 'microscopic', 'graph', 'graphic', 
            'telegraphic', 'micrograph', 'micrographic', 'porter', 'teleport', 'teleporter', 
            'teleportation', 'deport', 'deportable', 'deportation', 'telemeter', 'micrometer', 
            'chronometer', 'phone', 'telephonic', 'microphone', 'microphonic', 'chronic', 
            'subject', 'subjection', 'deject', 'dejection', 'interject', 'interjection', 
            'biotic', 'antibiotic'
        ]);

        // --- 2. Application State ---
        let state = {
            prefix: prefixes[0], // default 'none'
            root: null,          // must be selected
            suffix: suffixes[0], // default 'none'
            discovered: [],
            wordTypes: {}        // tracks if a discovered word is 'real' or 'mutant'
        };

        // --- 3. DOM Elements ---
        const els = {
            prefixList: document.getElementById('prefix-list'),
            rootList: document.getElementById('root-list'),
            suffixList: document.getElementById('suffix-list'),
            wordDisplay: document.getElementById('assembled-word'),
            meaningDisplay: document.getElementById('literal-meaning'),
            analyzeBtn: document.getElementById('analyze-btn'),
            mechDisplay: document.getElementById('mech-display'),
            verdict: document.getElementById('word-verdict'),
            discoveryList: document.getElementById('discovery-list'),
            realCount: document.getElementById('real-count'),
            mutantCount: document.getElementById('mutant-count'),
            clearLogBtn: document.getElementById('clear-log-btn'),
            
            // Writing Lab Elements
            openWritingBtn: document.getElementById('open-writing-btn'),
            writingLabModal: document.getElementById('writing-lab-modal'),
            closeWritingBtn: document.getElementById('close-writing-btn'),
            wordBankList: document.getElementById('word-bank-list'),
            storyTextarea: document.getElementById('story-textarea'),
            highlightLayer: document.getElementById('highlight-layer'),
            storyProgress: document.getElementById('story-progress'),
            sendStoryBtn: document.getElementById('send-story-btn')
        };

        // --- 4. Initialization & Rendering ---
        function init() {
            renderList(prefixes, els.prefixList, 'prefix');
            renderList(roots, els.rootList, 'root');
            renderList(suffixes, els.suffixList, 'suffix');
            
            // Set initial defaults visually
            selectPart('p_none', 'prefix');
            selectPart('s_none', 'suffix');

            els.analyzeBtn.addEventListener('click', analyzeWord);
            els.clearLogBtn.addEventListener('click', clearLog);
            
            // Writing Lab Listeners
            els.openWritingBtn.addEventListener('click', openWritingLab);
            els.closeWritingBtn.addEventListener('click', closeWritingLab);
            els.storyTextarea.addEventListener('input', handleTyping);
            els.storyTextarea.addEventListener('scroll', syncScroll);
            els.sendStoryBtn.addEventListener('click', sendStory);
        }

        function renderList(dataArray, container, type) {
            container.innerHTML = '';
            dataArray.forEach(item => {
                const btn = document.createElement('button');
                btn.id = `btn-${item.id}`;
                btn.className = `part-btn w-full p-2 rounded text-left flex flex-col`;
                btn.onclick = () => selectPart(item.id, type);
                
                const mainText = document.createElement('span');
                mainText.className = 'font-bold text-lg';
                mainText.innerText = item.text === '---' ? '[ NONE ]' : item.text + (type==='prefix'?'-' : type==='suffix'?'-':'');

                const subText = document.createElement('span');
                subText.className = 'text-xs text-sky-500 truncate';
                subText.innerText = item.meaning;

                btn.appendChild(mainText);
                btn.appendChild(subText);
                container.appendChild(btn);
            });
        }

        // --- 5. Logic & Interaction ---
        function selectPart(id, type) {
            // Remove active class from old selection
            let dataArray;
            if (type === 'prefix') dataArray = prefixes;
            if (type === 'root') dataArray = roots;
            if (type === 'suffix') dataArray = suffixes;

            const selectedItem = dataArray.find(i => i.id === id);
            
            // Update UI buttons
            const buttons = els[`${type}List`].querySelectorAll('button');
            buttons.forEach(b => b.classList.remove('active'));
            document.getElementById(`btn-${id}`).classList.add('active');

            // Update State
            state[type] = selectedItem;

            // Reset UI output
            updatePreview();
        }

        function updatePreview() {
            els.verdict.style.opacity = 0;
            els.mechDisplay.classList.remove('scanning');

            let wordStr = "";
            let prefixStr = state.prefix && state.prefix.type !== 'none' ? `<span class="text-sky-300">${state.prefix.text}-</span>` : "";
            let rootStr = state.root ? `<span class="text-white">${state.root.text}</span>` : `<span class="text-slate-500">[ROOT]</span>`;
            let suffixStr = state.suffix && state.suffix.type !== 'none' ? `<span class="text-sky-300">-${state.suffix.text}</span>` : "";

            els.wordDisplay.innerHTML = prefixStr + rootStr + suffixStr;
            els.meaningDisplay.innerText = "Awaiting Scanner...";
            els.meaningDisplay.className = "text-lg sm:text-xl text-emerald-600 mt-4 text-center max-w-lg h-8 italic";
        }

        function analyzeWord() {
            if (!state.root) {
                alertSystemMessage("Error: Core ROOT module missing.", "error");
                return;
            }

            // Trigger Animation
            els.mechDisplay.classList.remove('scanning');
            void els.mechDisplay.offsetWidth; // trigger reflow
            els.mechDisplay.classList.add('scanning');

            els.analyzeBtn.innerText = "[ SCANNING... ]";
            els.analyzeBtn.disabled = true;

            setTimeout(() => {
                processResults();
                els.analyzeBtn.innerText = "[ ENGAGE ANALYSIS SCANNER ]";
                els.analyzeBtn.disabled = false;
            }, 1000); // 1 second scan delay for effect
        }

        function processResults() {
            // 1. Build the Raw Word String
            let pText = state.prefix.type !== 'none' ? state.prefix.text : '';
            let rText = state.root.text;
            let sText = state.suffix.type !== 'none' ? state.suffix.text : '';
            
            let combinedWord = pText + rText + sText;

            // 2. Build the "Mech" Literal Meaning
            let meanings = [];
            // Robot logic usually puts suffix meaning first (e.g. "a person who" + "builds" + "again")
            if (state.suffix.meaning && state.suffix.type !== 'silent') meanings.push(state.suffix.meaning);
            if (state.prefix.meaning) meanings.push(state.prefix.meaning);
            if (state.root.meaning) meanings.push(state.root.meaning);

            let literalTranslation = meanings.join(" + ");
            if (state.suffix.type === 'silent') literalTranslation += " (Silent 'e' adjusts spelling/part of speech)";
            
            els.meaningDisplay.innerText = "Literal: " + literalTranslation;
            els.meaningDisplay.className = "text-lg sm:text-xl text-emerald-300 mt-4 text-center max-w-lg h-auto";

            // 3. Morphology Spelling Adjustments
            let displayWord = combinedWord;
            
            if (sText === 'tion') {
                if (rText === 'port') {
                    displayWord = pText + rText + 'ation';
                } else if (rText.endsWith('t')) {
                    displayWord = pText + rText.slice(0,-1) + sText; 
                }
            }

            if (sText === 'e') {
                if (rText === 'struct') displayWord = pText + 'structure';
                else if (rText === 'dict') displayWord = pText + 'dictate';
                else if (rText === 'phon') displayWord = pText + 'phone';
                else if (rText === 'scop') displayWord = pText + 'scope';
            }

            if (rText === 'meter' && pText === 'chron') displayWord = 'chronometer';
            if (rText === 'dict' && sText === 'or' && pText === '') displayWord = 'dictator';
            if (rText === 'dict' && sText === 'tion' && pText === '') displayWord = 'dictation';
            
            if (rText === 'bio') {
                if (sText === 'ology') displayWord = pText + 'biology';
                if (sText === 'ic') displayWord = pText + 'biotic';
            }
            
            const isReal = checkDictionary(displayWord, combinedWord);

            // 4. Update UI with Verdict
            els.wordDisplay.innerText = displayWord.toUpperCase();
            
            if (isReal) {
                els.verdict.innerText = "VERDICT: VALID ENGLISH WORD VALIDATED";
                els.verdict.className = "mt-4 px-4 py-1 rounded text-sm font-bold transition-opacity duration-300 border-2 text-green-400 border-green-400 bg-green-900/30 opacity-100";
                addToLog(displayWord, literalTranslation, 'real');
            } else {
                els.verdict.innerText = "VERDICT: MUTANT WORD DETECTED";
                els.verdict.className = "mt-4 px-4 py-1 rounded text-sm font-bold transition-opacity duration-300 border-2 text-purple-400 border-purple-400 bg-purple-900/30 opacity-100";
                addToLog(displayWord, literalTranslation, 'mutant');
            }
        }

        function checkDictionary(wordToCheck, exactCombination) {
            if (dictionary.has(wordToCheck.toLowerCase())) return true;
            if (dictionary.has(exactCombination.toLowerCase())) return true;
            return false;
        }

        function alertSystemMessage(msg, type) {
            els.meaningDisplay.innerText = msg;
            els.meaningDisplay.className = "text-lg sm:text-xl mt-4 text-center max-w-lg h-8 " + (type === 'error' ? 'text-red-500' : 'text-emerald-500');
        }

        // --- 6. Logging / Inventory ---
        function addToLog(word, meaning, type) {
            // Check if already in log to prevent spam
            if (state.discovered.includes(word.toLowerCase())) return;
            state.discovered.push(word.toLowerCase());
            state.wordTypes[word.toLowerCase()] = type; // Save type for coloring later

            // Remove empty message if it's the first item
            if (state.discovered.length === 1) {
                els.discoveryList.innerHTML = '';
            }

            // Show Writing Lab button if 10 words reached
            if (state.discovered.length >= 10) {
                els.openWritingBtn.classList.remove('hidden');
                els.openWritingBtn.classList.add('animate-pulse'); // Draw attention to it
                setTimeout(() => els.openWritingBtn.classList.remove('animate-pulse'), 3000);
            }

            const li = document.createElement('li');
            li.className = `p-2 rounded border border-slate-700 bg-slate-800 flex flex-col`;
            
            const header = document.createElement('div');
            header.className = 'flex justify-between items-center';
            
            const wSpan = document.createElement('span');
            wSpan.className = `font-bold text-lg ${type === 'real' ? 'text-green-400' : 'text-purple-400'}`;
            wSpan.innerText = word.toLowerCase();

            const badge = document.createElement('span');
            badge.className = `text-[10px] px-1 rounded uppercase border ${type === 'real' ? 'text-green-400 border-green-400' : 'text-purple-400 border-purple-400'}`;
            badge.innerText = type;

            header.appendChild(wSpan);
            header.appendChild(badge);

            const mSpan = document.createElement('span');
            mSpan.className = 'text-xs text-slate-400 mt-1';
            mSpan.innerText = meaning;

            li.appendChild(header);
            li.appendChild(mSpan);

            // Add to top of list
            els.discoveryList.insertBefore(li, els.discoveryList.firstChild);

            // Update Counts
            if (type === 'real') {
                els.realCount.innerText = parseInt(els.realCount.innerText) + 1;
            } else {
                els.mutantCount.innerText = parseInt(els.mutantCount.innerText) + 1;
            }
        }

        function clearLog() {
            state.discovered = [];
            state.wordTypes = {};
            els.discoveryList.innerHTML = '<li class="text-slate-500 italic text-center mt-4">Log empty. Start combining parts!</li>';
            els.realCount.innerText = '0';
            els.mutantCount.innerText = '0';
            els.openWritingBtn.classList.add('hidden');
        }

        // --- 7. Writing Lab Logic ---
        function openWritingLab() {
            els.writingLabModal.classList.remove('hidden');
            
            // Populate Word Bank
            els.wordBankList.innerHTML = '';
            state.discovered.forEach(word => {
                const span = document.createElement('span');
                const isReal = state.wordTypes[word] === 'real';
                span.className = `px-2 py-1 rounded border text-xs sm:text-sm shadow-sm ${isReal ? 'text-green-400 border-green-800 bg-green-900/20' : 'text-purple-400 border-purple-800 bg-purple-900/20'}`;
                span.innerText = word;
                els.wordBankList.appendChild(span);
            });

            // Trigger highlighting parse just in case they are re-opening it
            handleTyping();
            els.storyTextarea.focus();
        }

        function closeWritingLab() {
            els.writingLabModal.classList.add('hidden');
        }

        function syncScroll() {
            // Keeps the invisible text area aligned with the colored background layer
            els.highlightLayer.scrollTop = els.storyTextarea.scrollTop;
            els.highlightLayer.scrollLeft = els.storyTextarea.scrollLeft;
        }

        function handleTyping() {
            const rawText = els.storyTextarea.value;
            const wordsUsed = new Set();
            
            // 1. Escape HTML to prevent bugs in the backdrop
            let escapedText = rawText.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            
            // 2. Find words and wrap them in colored spans if they are in the bank
            const highlightedText = escapedText.replace(/\b([a-zA-Z]+)\b/g, (match, word) => {
                const lowerWord = word.toLowerCase();
                if (state.discovered.includes(lowerWord)) {
                    wordsUsed.add(lowerWord);
                    const type = state.wordTypes[lowerWord];
                    if (type === 'real') {
                        return `<span class="text-green-400 drop-shadow-[0_0_5px_rgba(74,222,128,0.8)] font-bold">${match}</span>`;
                    } else {
                        return `<span class="text-purple-400 drop-shadow-[0_0_5px_rgba(192,132,252,0.8)] font-bold">${match}</span>`;
                    }
                }
                return match;
            });

            // 3. Update the background layer (replace line breaks with <br> for HTML)
            els.highlightLayer.innerHTML = highlightedText.replace(/\n/g, '<br>') + '<br>'; // extra <br> fixes scrolling issue on last line

            // 4. Update Progress
            els.storyProgress.innerText = `${wordsUsed.size} / 10 Words Used`;
            if (wordsUsed.size >= 10) {
                els.storyProgress.classList.replace('text-emerald-400', 'text-yellow-400');
                els.storyProgress.classList.add('animate-pulse');
                els.sendStoryBtn.classList.remove('hidden');
            } else {
                els.storyProgress.classList.replace('text-yellow-400', 'text-emerald-400');
                els.storyProgress.classList.remove('animate-pulse');
                els.sendStoryBtn.classList.add('hidden');
            }
        }

        function sendStory() {
            // We will connect this to Google Apps script in Step 2!
            const storyText = els.storyTextarea.value;
            if(storyText.length < 10) return;
            
            alert("Step 2 Setup: Story ready to transmit! \n\nNext, we will wire this button up to send to your Google Sheet.");
        }

        // Initialize App
        window.onload = init;

    </script>
</body>
</html>
